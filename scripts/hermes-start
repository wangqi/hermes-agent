#!/usr/bin/env bash
# hermes-start — Start speaches STT service then launch Hermes
#
# Usage:
#   ./scripts/hermes-start [--gateway]   Run interactively (default: CLI mode)
#   ./scripts/hermes-start install       Install as a login service (launchd/systemd)
#   ./scripts/hermes-start uninstall     Remove the login service
#   ./scripts/hermes-start status        Show service status
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

SPEACHES_CONTAINER="speaches"
SPEACHES_IMAGE="ghcr.io/speaches-ai/speaches:latest-cpu"
SPEACHES_PORT="8000"
SPEACHES_HEALTH_URL="http://localhost:${SPEACHES_PORT}/health"
SPEACHES_HEALTH_TIMEOUT=30  # seconds to wait for speaches to become ready

LAUNCHD_LABEL="ai.hermes.start"
LAUNCHD_PLIST="${HOME}/Library/LaunchAgents/${LAUNCHD_LABEL}.plist"
LOG_DIR="${HOME}/.hermes/logs"

# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------

log()  { echo "[hermes-start] $*"; }
warn() { echo "[hermes-start] WARNING: $*" >&2; }

start_speaches() {
    log "Starting speaches container..."
    docker run --rm --detach \
        --publish "${SPEACHES_PORT}:8000" \
        --name "${SPEACHES_CONTAINER}" \
        --volume hf-hub-cache:/home/ubuntu/.cache/huggingface/hub \
        "${SPEACHES_IMAGE}" >/dev/null
    log "Speaches container started."
}

wait_for_speaches() {
    log "Waiting for speaches to be ready (timeout: ${SPEACHES_HEALTH_TIMEOUT}s)..."
    local elapsed=0
    until curl -sf "${SPEACHES_HEALTH_URL}" >/dev/null 2>&1; do
        if (( elapsed >= SPEACHES_HEALTH_TIMEOUT )); then
            warn "Speaches did not become ready in time — continuing anyway."
            return
        fi
        sleep 1
        (( elapsed++ ))
    done
    log "Speaches is ready."
}

# ---------------------------------------------------------------------------
# Speaches lifecycle
# ---------------------------------------------------------------------------

ensure_speaches() {
    if ! command -v docker &>/dev/null; then
        warn "Docker not found — skipping speaches startup. STT will be unavailable."
    elif docker inspect --format '{{.State.Running}}' "${SPEACHES_CONTAINER}" 2>/dev/null | grep -q true; then
        log "Speaches container is already running."
    else
        # Remove any stopped container with the same name before starting fresh
        docker rm -f "${SPEACHES_CONTAINER}" 2>/dev/null || true
        start_speaches
        wait_for_speaches
    fi
}

# ---------------------------------------------------------------------------
# Stop any existing Hermes process
# ---------------------------------------------------------------------------

stop_existing_hermes() {
    EXISTING_PIDS=$(pgrep -f "${PROJECT_DIR}/cli.py" 2>/dev/null || true)
    if [[ -n "$EXISTING_PIDS" ]]; then
        log "Stopping existing Hermes process(es): $EXISTING_PIDS"
        kill $EXISTING_PIDS 2>/dev/null || true
        # Wait up to 5s for clean exit, then force-kill
        deadline=$(( $(date +%s) + 5 ))
        while kill -0 $EXISTING_PIDS 2>/dev/null; do
            if (( $(date +%s) >= deadline )); then
                kill -9 $EXISTING_PIDS 2>/dev/null || true
                break
            fi
            sleep 0.5
        done
        log "Existing Hermes stopped."
    fi
}

# ---------------------------------------------------------------------------
# Run (default behaviour)
# ---------------------------------------------------------------------------

run_hermes() {
    ensure_speaches
    stop_existing_hermes
    log "Starting Hermes..."
    cd "${PROJECT_DIR}"
    exec /opt/homebrew/bin/uv run python cli.py "$@"
}

# ---------------------------------------------------------------------------
# launchd service management (macOS)
# ---------------------------------------------------------------------------

write_plist() {
    mkdir -p "${LOG_DIR}"
    cat > "${LAUNCHD_PLIST}" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${LAUNCHD_LABEL}</string>

    <key>ProgramArguments</key>
    <array>
        <string>${SCRIPT_DIR}/hermes-start</string>
        <string>--gateway</string>
    </array>

    <key>WorkingDirectory</key>
    <string>${PROJECT_DIR}</string>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>

    <key>StandardOutPath</key>
    <string>${LOG_DIR}/gateway.log</string>

    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/gateway.error.log</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
        <key>HOME</key>
        <string>${HOME}</string>
    </dict>
</dict>
</plist>
PLIST
}

install_service() {
    if [[ "$(uname)" != "Darwin" ]]; then
        warn "install is only supported on macOS. On Linux, use systemd manually."
        exit 1
    fi

    write_plist

    # Unload first in case an old version is loaded
    launchctl unload "${LAUNCHD_PLIST}" 2>/dev/null || true
    launchctl load -w "${LAUNCHD_PLIST}"

    log "Service installed: ${LAUNCHD_LABEL}"
    log "Plist:  ${LAUNCHD_PLIST}"
    log "Logs:   ${LOG_DIR}/gateway.log"
    log ""
    log "Hermes gateway will now start automatically on login."
    log "To manage manually:"
    log "  launchctl start ${LAUNCHD_LABEL}"
    log "  launchctl stop  ${LAUNCHD_LABEL}"
    log "  ${SCRIPT_DIR}/hermes-start status"
    log "  ${SCRIPT_DIR}/hermes-start uninstall"
}

uninstall_service() {
    if [[ ! -f "${LAUNCHD_PLIST}" ]]; then
        warn "No plist found at ${LAUNCHD_PLIST} — nothing to uninstall."
        exit 0
    fi
    launchctl unload "${LAUNCHD_PLIST}" 2>/dev/null || true
    rm -f "${LAUNCHD_PLIST}"
    log "Service uninstalled: ${LAUNCHD_LABEL}"
}

status_service() {
    echo "=== launchctl status ==="
    launchctl list "${LAUNCHD_LABEL}" 2>/dev/null || echo "(not loaded)"
    echo ""
    echo "=== plist ==="
    if [[ -f "${LAUNCHD_PLIST}" ]]; then
        echo "Found: ${LAUNCHD_PLIST}"
    else
        echo "Not installed"
    fi
    echo ""
    echo "=== recent logs ==="
    if [[ -f "${LOG_DIR}/gateway.log" ]]; then
        tail -20 "${LOG_DIR}/gateway.log"
    else
        echo "(no log file yet)"
    fi
}

# ---------------------------------------------------------------------------
# Dispatch
# ---------------------------------------------------------------------------

case "${1:-}" in
    install)   install_service ;;
    uninstall) uninstall_service ;;
    status)    status_service ;;
    *)         run_hermes "$@" ;;
esac
